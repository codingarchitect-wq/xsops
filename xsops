#!/bin/bash
# ~/bin/secrets

set -euo pipefail

find_project_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -f "$dir/.sops.yaml" ]] || [[ -d "$dir/secrets" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    return 1
}

usage() {
    echo "Usage: xsops <command> <env> [-- <cmd>]"
    echo ""
    echo "Commands:"
    echo "  run <env> -- <cmd>    Run command with secrets loaded"
    echo "  edit <env>            Edit secrets file"
    echo "  view <env>            View decrypted secrets"
    echo "  which <env>           Show resolved paths"
    echo ""    
}

CMD="${1:-}"
ENV="${2:-}"

if [[ -z "$CMD" ]]; then
    usage
    exit 1
fi

PROJECT_ROOT="$(find_project_root)" || {
    echo "Error: Could not find project root (no .sops.yaml or secrets/ directory found)"
    exit 1
}

if [[ -z "$ENV" ]]; then
    echo "Error: Environment required (common, dev, prod)"
    exit 1
fi

SECRETS_FILE="$PROJECT_ROOT/secrets/${ENV}/env.yaml"

if [[ ! -f "$SECRETS_FILE" && "$CMD" != "which" ]]; then
    echo "Error: Secrets file not found: $SECRETS_FILE"
    exit 1
fi

case "$CMD" in
    run)
        shift 2  # Remove 'run' and env
        [[ "${1:-}" == "--" ]] && shift
        sops exec-env "$SECRETS_FILE" -- "${*}"
        ;;
    edit)
        sops "$SECRETS_FILE"
        ;;
    view)
        sops -d "$SECRETS_FILE"
        ;;
    which)
        echo "Project root: $PROJECT_ROOT"
        echo "Secrets file: $SECRETS_FILE"
        ;;
    *)
        usage
        exit 1
        ;;
esac
